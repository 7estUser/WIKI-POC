# Spring Core RCE 漏洞利用

## 利用条件：

- jdk9及以上
- 部署在tomcat的应用
- springmvc的或者webflux的应用

## 利用方法：

#### 步骤一：

[利用脚本](https://github.com/user-error-404/WIKI-POC/blob/main/Wiki/开发框架漏洞/Spring/Spring4Shell(CVE-2022-22965)/file/spring-core-rce.py)进行漏洞利用和RCE执行

## 漏洞原理：

springmvc框架接受前端传入的参数，接收的数据类型是一个POJO的时候，像这样：
```java
@RequestMapping(value = "/rtest", method = RequestMethod.GET)
public String register2(HelloWorld obj, Model model) throws Exception {
    model.addAttribute("data", obj.toString());
    return "index";
}
```
> springmvc框架会将请求的数据，转成了POJO对象。也是因为这个自动封住功能造成了POC，传进来的data由对象的class作为引子， 然后springmvc会一步步反射拿属性的方式最终是给AccessLogValve对象的几个属性的赋值操作。  
#### 漏洞利用链为：
- 调用封装对象类的getClass() 拿到Class对象
- 通过Class对象调用getModule()
- 通过Module调用getClassLoader()
- 通过ClassLoader拿resources

> resources中的属性：
- context是Tomcat的StandardContext
- parent拿到的是StandardEngine
- pipeline拿到的是StandardPipeline
- first拿到的是AccessLogValve

> AccessLogValve是tomcat记录日志的,属性包括：
- pattern是日志格式
- suffix是日志文件的后缀
- prefix是日志文件的前缀
- fileDateFormat是日期文件的时间格式

#### 条件限制原因
- 为啥是jdk9及以上版本呢，因为module的概念是从jdk9开始的。
- 为啥是得部署到tomcat里的应用呢，因为只有这样才会利用它的日志功能